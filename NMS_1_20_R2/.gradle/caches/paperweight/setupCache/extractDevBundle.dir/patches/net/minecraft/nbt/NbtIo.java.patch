--- a/net/minecraft/nbt/NbtIo.java
+++ b/net/minecraft/nbt/NbtIo.java
@@ -1,3 +1,4 @@
+// mc-dev import
 package net.minecraft.nbt;
 
 import java.io.BufferedOutputStream;
@@ -20,10 +21,28 @@
 import net.minecraft.util.FastBufferedInputStream;
 
 public class NbtIo {
+
+    public NbtIo() {}
+
     public static CompoundTag readCompressed(File file) throws IOException {
-        try (InputStream inputStream = new FileInputStream(file)) {
-            return readCompressed(inputStream);
+        FileInputStream fileinputstream = new FileInputStream(file);
+
+        CompoundTag nbttagcompound;
+
+        try {
+            nbttagcompound = NbtIo.readCompressed((InputStream) fileinputstream);
+        } catch (Throwable throwable) {
+            try {
+                fileinputstream.close();
+            } catch (Throwable throwable1) {
+                throwable.addSuppressed(throwable1);
+            }
+
+            throw throwable;
         }
+
+        fileinputstream.close();
+        return nbttagcompound;
     }
 
     private static DataInputStream createDecompressorStream(InputStream stream) throws IOException {
@@ -31,47 +50,138 @@
     }
 
     public static CompoundTag readCompressed(InputStream stream) throws IOException {
-        try (DataInputStream dataInputStream = createDecompressorStream(stream)) {
-            return read(dataInputStream, NbtAccounter.unlimitedHeap());
+        DataInputStream datainputstream = NbtIo.createDecompressorStream(stream);
+
+        CompoundTag nbttagcompound;
+
+        try {
+            nbttagcompound = NbtIo.read(datainputstream, NbtAccounter.unlimitedHeap());
+        } catch (Throwable throwable) {
+            if (datainputstream != null) {
+                try {
+                    datainputstream.close();
+                } catch (Throwable throwable1) {
+                    throwable.addSuppressed(throwable1);
+                }
+            }
+
+            throw throwable;
         }
+
+        if (datainputstream != null) {
+            datainputstream.close();
+        }
+
+        return nbttagcompound;
     }
 
     public static void parseCompressed(File file, StreamTagVisitor scanner, NbtAccounter tracker) throws IOException {
-        try (InputStream inputStream = new FileInputStream(file)) {
-            parseCompressed(inputStream, scanner, tracker);
+        FileInputStream fileinputstream = new FileInputStream(file);
+
+        try {
+            NbtIo.parseCompressed((InputStream) fileinputstream, scanner, tracker);
+        } catch (Throwable throwable) {
+            try {
+                fileinputstream.close();
+            } catch (Throwable throwable1) {
+                throwable.addSuppressed(throwable1);
+            }
+
+            throw throwable;
         }
 
+        fileinputstream.close();
     }
 
     public static void parseCompressed(InputStream stream, StreamTagVisitor scanner, NbtAccounter tracker) throws IOException {
-        try (DataInputStream dataInputStream = createDecompressorStream(stream)) {
-            parse(dataInputStream, scanner, tracker);
+        DataInputStream datainputstream = NbtIo.createDecompressorStream(stream);
+
+        try {
+            NbtIo.parse(datainputstream, scanner, tracker);
+        } catch (Throwable throwable) {
+            if (datainputstream != null) {
+                try {
+                    datainputstream.close();
+                } catch (Throwable throwable1) {
+                    throwable.addSuppressed(throwable1);
+                }
+            }
+
+            throw throwable;
+        }
+
+        if (datainputstream != null) {
+            datainputstream.close();
         }
 
     }
 
     public static void writeCompressed(CompoundTag nbt, File file) throws IOException {
-        try (OutputStream outputStream = new FileOutputStream(file)) {
-            writeCompressed(nbt, outputStream);
+        FileOutputStream fileoutputstream = new FileOutputStream(file);
+
+        try {
+            NbtIo.writeCompressed(nbt, (OutputStream) fileoutputstream);
+        } catch (Throwable throwable) {
+            try {
+                fileoutputstream.close();
+            } catch (Throwable throwable1) {
+                throwable.addSuppressed(throwable1);
+            }
+
+            throw throwable;
         }
 
+        fileoutputstream.close();
     }
 
     public static void writeCompressed(CompoundTag nbt, OutputStream stream) throws IOException {
-        try (DataOutputStream dataOutputStream = new DataOutputStream(new BufferedOutputStream(new GZIPOutputStream(stream)))) {
-            write(nbt, dataOutputStream);
+        DataOutputStream dataoutputstream = new DataOutputStream(new BufferedOutputStream(new GZIPOutputStream(stream)));
+
+        try {
+            NbtIo.write(nbt, (DataOutput) dataoutputstream);
+        } catch (Throwable throwable) {
+            try {
+                dataoutputstream.close();
+            } catch (Throwable throwable1) {
+                throwable.addSuppressed(throwable1);
+            }
+
+            throw throwable;
         }
 
+        dataoutputstream.close();
     }
 
     public static void write(CompoundTag nbt, File file) throws IOException {
-        try (
-            FileOutputStream fileOutputStream = new FileOutputStream(file);
-            DataOutputStream dataOutputStream = new DataOutputStream(fileOutputStream);
-        ) {
-            write(nbt, dataOutputStream);
+        FileOutputStream fileoutputstream = new FileOutputStream(file);
+
+        try {
+            DataOutputStream dataoutputstream = new DataOutputStream(fileoutputstream);
+
+            try {
+                NbtIo.write(nbt, (DataOutput) dataoutputstream);
+            } catch (Throwable throwable) {
+                try {
+                    dataoutputstream.close();
+                } catch (Throwable throwable1) {
+                    throwable.addSuppressed(throwable1);
+                }
+
+                throw throwable;
+            }
+
+            dataoutputstream.close();
+        } catch (Throwable throwable2) {
+            try {
+                fileoutputstream.close();
+            } catch (Throwable throwable3) {
+                throwable2.addSuppressed(throwable3);
+            }
+
+            throw throwable2;
         }
 
+        fileoutputstream.close();
     }
 
     @Nullable
@@ -79,62 +189,94 @@
         if (!file.exists()) {
             return null;
         } else {
-            CompoundTag var3;
-            try (
-                FileInputStream fileInputStream = new FileInputStream(file);
-                DataInputStream dataInputStream = new DataInputStream(fileInputStream);
-            ) {
-                var3 = read(dataInputStream, NbtAccounter.unlimitedHeap());
+            FileInputStream fileinputstream = new FileInputStream(file);
+
+            CompoundTag nbttagcompound;
+
+            try {
+                DataInputStream datainputstream = new DataInputStream(fileinputstream);
+
+                try {
+                    nbttagcompound = NbtIo.read(datainputstream, NbtAccounter.unlimitedHeap());
+                } catch (Throwable throwable) {
+                    try {
+                        datainputstream.close();
+                    } catch (Throwable throwable1) {
+                        throwable.addSuppressed(throwable1);
+                    }
+
+                    throw throwable;
+                }
+
+                datainputstream.close();
+            } catch (Throwable throwable2) {
+                try {
+                    fileinputstream.close();
+                } catch (Throwable throwable3) {
+                    throwable2.addSuppressed(throwable3);
+                }
+
+                throw throwable2;
             }
 
-            return var3;
+            fileinputstream.close();
+            return nbttagcompound;
         }
     }
 
     public static CompoundTag read(DataInput input) throws IOException {
-        return read(input, NbtAccounter.unlimitedHeap());
+        return NbtIo.read(input, NbtAccounter.unlimitedHeap());
     }
 
     public static CompoundTag read(DataInput input, NbtAccounter tracker) throws IOException {
-        Tag tag = readUnnamedTag(input, tracker);
-        if (tag instanceof CompoundTag) {
-            return (CompoundTag)tag;
+        // Spigot start
+        if ( input instanceof io.netty.buffer.ByteBufInputStream )
+        {
+            input = new DataInputStream(new org.spigotmc.LimitStream((InputStream) input, tracker));
+        }
+        // Spigot end
+        Tag nbtbase = NbtIo.readUnnamedTag(input, tracker);
+
+        if (nbtbase instanceof CompoundTag) {
+            return (CompoundTag) nbtbase;
         } else {
             throw new IOException("Root tag must be a named compound tag");
         }
     }
 
     public static void write(CompoundTag nbt, DataOutput output) throws IOException {
-        writeUnnamedTag(nbt, output);
+        NbtIo.writeUnnamedTag(nbt, output);
     }
 
     public static void parse(DataInput input, StreamTagVisitor scanner, NbtAccounter tracker) throws IOException {
-        TagType<?> tagType = TagTypes.getType(input.readByte());
-        if (tagType == EndTag.TYPE) {
+        TagType<?> nbttagtype = TagTypes.getType(input.readByte());
+
+        if (nbttagtype == EndTag.TYPE) {
             if (scanner.visitRootEntry(EndTag.TYPE) == StreamTagVisitor.ValueResult.CONTINUE) {
                 scanner.visitEnd();
             }
 
         } else {
-            switch (scanner.visitRootEntry(tagType)) {
+            switch (scanner.visitRootEntry(nbttagtype)) {
                 case HALT:
                 default:
                     break;
                 case BREAK:
                     StringTag.skipString(input);
-                    tagType.skip(input, tracker);
+                    nbttagtype.skip(input, tracker);
                     break;
                 case CONTINUE:
                     StringTag.skipString(input);
-                    tagType.parse(input, scanner, tracker);
+                    nbttagtype.parse(input, scanner, tracker);
             }
 
         }
     }
 
     public static Tag readAnyTag(DataInput input, NbtAccounter tracker) throws IOException {
-        byte b = input.readByte();
-        return (Tag)(b == 0 ? EndTag.INSTANCE : readTagSafe(input, tracker, b));
+        byte b0 = input.readByte();
+
+        return (Tag) (b0 == 0 ? EndTag.INSTANCE : NbtIo.readTagSafe(input, tracker, b0));
     }
 
     public static void writeAnyTag(Tag nbt, DataOutput output) throws IOException {
@@ -153,23 +295,25 @@
     }
 
     private static Tag readUnnamedTag(DataInput input, NbtAccounter tracker) throws IOException {
-        byte b = input.readByte();
-        if (b == 0) {
+        byte b0 = input.readByte();
+
+        if (b0 == 0) {
             return EndTag.INSTANCE;
         } else {
             StringTag.skipString(input);
-            return readTagSafe(input, tracker, b);
+            return NbtIo.readTagSafe(input, tracker, b0);
         }
     }
 
     private static Tag readTagSafe(DataInput input, NbtAccounter tracker, byte typeId) {
         try {
             return TagTypes.getType(typeId).load(input, tracker);
-        } catch (IOException var6) {
-            CrashReport crashReport = CrashReport.forThrowable(var6, "Loading NBT data");
-            CrashReportCategory crashReportCategory = crashReport.addCategory("NBT Tag");
-            crashReportCategory.setDetail("Tag type", typeId);
-            throw new ReportedException(crashReport);
+        } catch (IOException ioexception) {
+            CrashReport crashreport = CrashReport.forThrowable(ioexception, "Loading NBT data");
+            CrashReportCategory crashreportsystemdetails = crashreport.addCategory("NBT Tag");
+
+            crashreportsystemdetails.setDetail("Tag type", (Object) typeId);
+            throw new ReportedException(crashreport);
         }
     }
 }
